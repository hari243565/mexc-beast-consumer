#!/usr/bin/env python3
import os, asyncio, json, random
import websockets
from websockets.exceptions import ConnectionClosedError, ConnectionClosedOK

URL = "wss://wbs-api.mexc.com/ws"
SYMBOL = os.environ.get("MEXC_SYMBOL", "BTC_USDT")
SYM_UP = SYMBOL.replace("_","").upper()
OUT_DIR = "/opt/mexc/ingest"
os.makedirs(OUT_DIR, exist_ok=True)

async def consumer_loop():
    attempt = 0
    while True:
        try:
            async with websockets.connect(
                URL,
                ping_interval=25,   # send ping every 25 s
                ping_timeout=10,    # wait ≤10 s for pong
                max_size=None
            ) as ws:
                attempt = 0
                sub_msg = {
                    "method": "SUBSCRIPTION",
                    "params": [f"spot@public.deals.v3.api@{SYM_UP}"],
                    "id": random.randint(1, 1_000_000)
                }
                await ws.send(json.dumps(sub_msg))
                print("✅ Sent subscription:", sub_msg, flush=True)

                idx = 0
                while True:
                    msg = await ws.recv()
                    with open(f"{OUT_DIR}/feed-{idx%10}.ndjson", "a") as fh:
                        if isinstance(msg, bytes):
                            fh.write(msg.hex()+"\n")
                        else:
                            fh.write(msg+"\n")
                    print("Wrote frame", flush=True)
                    idx += 1

        except (ConnectionClosedError, ConnectionClosedOK) as e:
            print(f"⚠️ Closed (code={getattr(e,'code',None)} reason={getattr(e,'reason',None)})", flush=True)
            backoff = min(60, 2**attempt)
            await asyncio.sleep(backoff + random.uniform(0,1))
            attempt += 1
        except Exception as e:
            print("⚠️ Unexpected:", e, flush=True)
            await asyncio.sleep(2)
            attempt += 1

if __name__ == "__main__":
    asyncio.run(consumer_loop())
